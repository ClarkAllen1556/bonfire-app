<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.25.5">
    <meta name="project" content="bonfire v0.1.0-cooperation-beta.42">

    <title>Bonfire Architecture — bonfire v0.1.0-cooperation-beta.42</title>
    <link rel="stylesheet" href="dist/elixir-d1506dba1db7cdc5483e.css" />

    <script src="dist/sidebar_items-da55e8198a.js"></script>

      <script src="docs_config.js"></script>

    <script async src="dist/app-7b632b26f13d5e0d20e1.js"></script>


  </head>
  <body data-type="extras">
    <script>

      try {
        if (localStorage.getItem('night-mode') === 'true') {
          document.body.classList.add('night-mode');
        }
      } catch (error) { }
    </script>

<div class="main">

<button class="sidebar-button sidebar-toggle">
  <span class="icon-menu" title="Collapse/expand sidebar"></span>
</button>

<section class="sidebar">
  <form class="sidebar-search" action="search.html">
    <button type="submit" class="search-button" aria-label="Submit Search">
      <span class="icon-search" aria-hidden="true" title="Submit search"></span>
    </button>
    <button type="button" tabindex="-1" class="search-close-button" aria-label="Cancel Search">
      <span class="icon-cross" aria-hidden="true" title="Cancel search"></span>
    </button>
    <label class="search-label">
      <input name="q" type="text" class="search-input" placeholder="Search..." aria-label="Input your search terms" autocomplete="off" />
    </label>
  </form>

  <div class="autocomplete">
    <div class="autocomplete-results">
    </div>
  </div>

  <div class="sidebar-header">
    <div class="sidebar-projectDetails">
      <a href="readme.html" class="sidebar-projectName">
bonfire
      </a>
      <strong class="sidebar-projectVersion">
        v0.1.0-cooperation-beta.42
      </strong>
    </div>

      <a href="readme.html">
        <img src="assets/logo.png" alt="bonfire" class="sidebar-projectImage">
      </a>

  </div>

  <ul class="sidebar-listNav">
    <li><a id="extras-list-link" href="#full-list">Pages</a></li>

      <li><a id="modules-list-link" href="#full-list">Modules</a></li>


      <li><a id="tasks-list-link" href="#full-list">Mix Tasks</a></li>

  </ul>
  <div class="gradient"></div>
  <ul id="full-list" class="sidebar-fullList"></ul>
</section>

<section class="content">
  <div class="content-outer">
    <div id="content" class="content-inner">

<h1 id="content">
Bonfire Architecture

</h1>

<h2 id="hacking" class="section-heading">
  <a href="#hacking" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Hacking
</h2>
<p>This is an unusual piece of software, developed in an unusual
way. It started with requests by Moodle users to be able to share and
collaborate on educational resources with their peers.</p><p>Hacking on it is actually pretty fun. The codebase has a unique
feeling to work with and we've relentlessly refactored to manage the
ever-growing complexity that a distributed social network
implies. This said, it is not easy to understand without context,
which is what this section is here to provide.</p><h2 id="design-decisions" class="section-heading">
  <a href="#design-decisions" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Design Decisions
</h2>
<p>Feature goals:</p><ul><li>Flexibility for developers and deployments.</li><li>Integrated federation with the existing fediverse.</li></ul><p>Operational goals:</p><ul><li>Easy to set up and run.</li><li>Light on resources for small deployments.</li><li>Scalable for large deployments.</li></ul><p>Operationally, there's a tension between wanting to be able to scale
instances and not wanting to burden small instances with
high resource requirements or difficult setup.</p><p>There are no easy answers to this. Our current solution is heavily
reliant on postgresql. We will monitor perforamnce and scaling and
continually evolve our strategy.</p><h2 id="stack" class="section-heading">
  <a href="#stack" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Stack
</h2>
<p>Our implementation language is <a href="https://www.elixir-lang.org/">Elixir</a>,
a language designed for building reliable systems. We use the
<a href="https://www.phoenixframework.org/">Phoenix</a> web framework.</p><p>Some extensions use LiveView and Surface for UI components and views.</p><p>Some extensions use the <a href="https://absinthe-graphql.org/">Absinthe</a> GraphQL library to deliver a GraphQL API.</p><p>We like our stack and we have no interest in rewriting in PHP, thanks
for not asking.</p><h2 id="code-structure" class="section-heading">
  <a href="#code-structure" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Code Structure
</h2>
<p>The server code is broadly composed of these parts.</p><ul><li><code class="inline">Bonfire.*</code> - Core application logic (very little code).</li><li><code class="inline">Bonfire.*.*</code> - Bonfire extensions (eg <a href="https://hexdocs.pm/bonfire_social/0.1.0/Bonfire.Social.Posts.html"><code class="inline">Bonfire.Social.Posts</code></a>)</li><li><code class="inline">Bonfire.Data.*</code> - Schemas etc.</li><li><code class="inline">Bonfire.Web.*</code> - Phoenix webapp</li><li><code class="inline">Bonfire.GraphQL.*</code> - Optional GraphQL API.</li><li><a href="https://hexdocs.pm/activity_pub/0.1.0/ActivityPub.html"><code class="inline">ActivityPub</code></a> - ActivityPub S2S models, logic and various helper modules (adapted Pleroma code)</li><li><a href="https://hexdocs.pm/activity_pub/0.1.0/ActivityPubWeb.html"><code class="inline">ActivityPubWeb</code></a> - ActivityPub S2S REST endpoints, activity ingestion and push federation facilities (adapted Pleroma code)</li><li><code class="inline">ValueFlows.*</code> - economic extensions</li></ul><h3 id="bonfire" class="section-heading">
  <a href="#bonfire" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  <code class="inline">Bonfire</code>
</h3>
<p>This namespace contains the core business logic. Every <code class="inline">Bonfire</code> object type has at least context module (e. g. <code class="inline">Bonfire.Communities</code>), a model/schema module (<code class="inline">Bonfire.Communities.Community</code>) and a queries module (<code class="inline">Bonfire.Communities.Queries</code>).</p><p>All <code class="inline">Bonfire</code> objects use an ULID as their primary key. We use the pointers library (<a href="https://hexdocs.pm/bonfire_common/0.1.0/Bonfire.Common.Pointers.html"><code class="inline">Bonfire.Common.Pointers</code></a>) to reference any object by its primary key without knowing what type it is beforehand. This is very useful as we allow for example following or liking many different types of objects and this approach allows us to store the context of the like/follow by only storing its primary key (see <code class="inline">Bonfire.Follows.Follow</code>) for an example.</p><p>All context modules have a <code class="inline">one/1</code> and <code class="inline">many/1</code> function for fetching objects. These take a keyword list as filters as arguments allowing objects to be fetched by arbitrary criteria defined in the queries modules.</p><p>Examples:</p><pre><code class="makeup elixir"><span class="nc">Communities</span><span class="o">.</span><span class="n">one</span><span class="p" data-group-id="0068909898-1">(</span><span class="ss">username</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bob&quot;</span><span class="p" data-group-id="0068909898-1">)</span><span class="w"> </span><span class="c1"># Fetching by username</span><span class="w">
</span><span class="nc">Collections</span><span class="o">.</span><span class="n">many</span><span class="p" data-group-id="0068909898-2">(</span><span class="ss">community</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;01E9TQP93S8XFSV2ZATX1FQ528&quot;</span><span class="p" data-group-id="0068909898-2">)</span><span class="w"> </span><span class="c1"># Fetching collections by its parent community</span><span class="w">
</span><span class="nc">Resources</span><span class="o">.</span><span class="n">many</span><span class="p" data-group-id="0068909898-3">(</span><span class="ss">deleted</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="0068909898-3">)</span><span class="w"> </span><span class="c1"># Fetching all undeleted communities</span></code></pre><p>Context modules also have functions for creating, updating and deleting objects. These actions are passed to the AP layer via the <code class="inline">Bonfire.Workers.APPublishWorker</code> module.</p><h4>Contexts</h4><p>The <code class="inline">Bonfire</code> namespace is occupied mostly by contexts. These are
top level modules which comprise a grouping of:</p><ul><li>A top level library module</li><li>Additional library modules</li><li>OTP services</li><li>Ecto schemas</li></ul><p>Here are some of the current extensions, or modules therin:</p><ul><li><code class="inline">Bonfire.Boundaries</code> (for managing and querying email whitelists)</li><li><a href="https://hexdocs.pm/bonfire_social/0.1.0/Bonfire.Social.FeedActivities.html"><code class="inline">Bonfire.Social.FeedActivities</code></a> and <a href="https://hexdocs.pm/bonfire_social/0.1.0/Bonfire.Social.Activities.html"><code class="inline">Bonfire.Social.Activities</code></a> and<a href="https://hexdocs.pm/bonfire_social/0.1.0/Bonfire.Social.Activities.html"><code class="inline">Bonfire.Social.Activities</code></a> (for managing and querying activities, the unit of a feed)</li><li><a href="https://hexdocs.pm/bonfire_social/0.1.0/Bonfire.Social.Feeds.html"><code class="inline">Bonfire.Social.Feeds</code></a> (for managing and querying feeds)</li><li><a href="https://hexdocs.pm/bonfire_social/0.1.0/Bonfire.Social.Flags.html"><code class="inline">Bonfire.Social.Flags</code></a> (for managing and querying flags)</li><li><a href="https://hexdocs.pm/bonfire_social/0.1.0/Bonfire.Social.Follows.html"><code class="inline">Bonfire.Social.Follows</code></a> (for managing and querying follows)</li><li><code class="inline">Bonfire.Instance</code> (for managing the local instance)</li><li><a href="https://hexdocs.pm/bonfire_me/0.1.0/Bonfire.Me.Mails.html"><code class="inline">Bonfire.Me.Mails</code></a> (for rendering and sending emails)</li><li><a href="https://hexdocs.pm/bonfire_social/0.1.0/Bonfire.Social.Threads.html"><code class="inline">Bonfire.Social.Threads</code></a> (for managing and querying threads and comments)</li><li><a href="https://hexdocs.pm/bonfire_me/0.1.0/Bonfire.Me.Users.html"><code class="inline">Bonfire.Me.Users</code></a> (for managing and querying both local and remote users)</li><li><a href="https://hexdocs.pm/bonfire_files/0.1.0/Bonfire.Files.html"><code class="inline">Bonfire.Files</code></a> (for managing uploaded content)</li><li><a href="https://hexdocs.pm/bonfire_me/0.1.0/Bonfire.Me.Characters.html"><code class="inline">Bonfire.Me.Characters</code></a> (a shared abstraction over users, communities, collections, and other objects that need to have feeds and act as an actor in ActivityPub land)</li><li><a href="https://hexdocs.pm/bonfire_search/0.1.0/Bonfire.Search.html"><code class="inline">Bonfire.Search</code></a> (local search indexing and search API, powered by Meili)</li></ul><h4>Additional extensions and modules</h4><ul><li><code class="inline">Bonfire.Application</code> (OTP application)</li><li><code class="inline">Bonfire.Federate.ActivityPub</code> (ActivityPub integration)</li><li><code class="inline">Bonfire.Common</code> (stuff that gets used everywhere)</li><li><a href="https://hexdocs.pm/bonfire_api_graphql/0.1.0/Bonfire.GraphQL.html"><code class="inline">Bonfire.GraphQL</code></a> (GraphQL abstractions)</li><li><code class="inline">Bonfire.Queries</code> (Helpers for making queries)</li><li><a href="https://hexdocs.pm/bonfire_common/0.1.0/Bonfire.Repo.html"><code class="inline">Bonfire.Repo</code></a> (Ecto repository)</li></ul><h3 id="bonfire-web" class="section-heading">
  <a href="#bonfire-web" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  <code class="inline">Bonfire.Web</code>
</h3>
<p>Structure:</p><ul><li>Endpoint</li><li>Router</li><li>Controllers</li><li>Views</li><li>Plugs</li><li>GraphQL<ul><li>Schemas</li><li>Resolvers</li><li>Middleware</li><li>Pipeline</li><li>Flows</li></ul></li></ul><p>See the <a href="graphql.html">GraphQL API documentation</a></p><h3 id="activitypub" class="section-heading">
  <a href="#activitypub" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  <a href="https://hexdocs.pm/activity_pub/0.1.0/ActivityPub.html"><code class="inline">ActivityPub</code></a>
</h3>
<p>This namespace handles the ActivityPub logic and stores AP activitities. It is largely adapted Pleroma code with some modifications, for example merging of the activity and object tables and new actor object abstraction.</p><p>It also contains some functionality that isn't part of the AP spec but is required for federation:</p><ul><li><a href="https://hexdocs.pm/activity_pub/0.1.0/ActivityPub.Keys.html"><code class="inline">ActivityPub.Keys</code></a> - Generating and handling RSA keys for messagage signing</li><li><a href="https://hexdocs.pm/activity_pub/0.1.0/ActivityPub.Signature.html"><code class="inline">ActivityPub.Signature</code></a> - Adapter for the HTTPSignature library</li><li><a href="https://hexdocs.pm/activity_pub/0.1.0/ActivityPub.WebFinger.html"><code class="inline">ActivityPub.WebFinger</code></a> - Implementation of the WebFinger protocol</li><li><a href="https://hexdocs.pm/activity_pub/0.1.0/ActivityPub.HTTP.html"><code class="inline">ActivityPub.HTTP</code></a> - Module for making HTTP requests (wrapper around tesla)</li><li><a href="https://hexdocs.pm/activity_pub/0.1.0/ActivityPub.Instances.html"><code class="inline">ActivityPub.Instances</code></a> - Module for storing reachability information about remote instances</li></ul><p><a href="https://hexdocs.pm/activity_pub/0.1.0/ActivityPub.html"><code class="inline">ActivityPub</code></a> contains the main API and is documented there. <a href="https://hexdocs.pm/activity_pub/0.1.0/ActivityPub.Adapter.html"><code class="inline">ActivityPub.Adapter</code></a> defines callback functions for the AP library.</p><h3 id="activitypubweb" class="section-heading">
  <a href="#activitypubweb" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  <a href="https://hexdocs.pm/activity_pub/0.1.0/ActivityPubWeb.html"><code class="inline">ActivityPubWeb</code></a>
</h3>
<p>This namespace contains the AP S2S REST API, the activity ingestion pipeline (<a href="https://hexdocs.pm/activity_pub/0.1.0/ActivityPubWeb.Transmogrifier.html"><code class="inline">ActivityPubWeb.Transmogrifier</code></a>) and the push federation facilities (<a href="https://hexdocs.pm/activity_pub/0.1.0/ActivityPubWeb.Federator.html"><code class="inline">ActivityPubWeb.Federator</code></a>, <a href="https://hexdocs.pm/activity_pub/0.1.0/ActivityPubWeb.Publisher.html"><code class="inline">ActivityPubWeb.Publisher</code></a> and others). The outgoing federation module is designed in a modular way allowing federating through different protocols in the future.</p><h3 id="activitypub-interaction-in-our-application-logic" class="section-heading">
  <a href="#activitypub-interaction-in-our-application-logic" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  <a href="https://hexdocs.pm/activity_pub/0.1.0/ActivityPub.html"><code class="inline">ActivityPub</code></a> interaction in our application logic
</h3>
<p>The callback functions defined in <a href="https://hexdocs.pm/activity_pub/0.1.0/ActivityPub.Adapter.html"><code class="inline">ActivityPub.Adapter</code></a> are implemented in <code class="inline">Bonfire.ActivityPub.Adapter</code>. Facilities for calling the ActivityPub API are implemented in <code class="inline">Bonfire.ActivityPub.Publisher</code>. When implementing federation for a new object type it needs to be implemented both ways: both for outgoing federation in <code class="inline">Bonfire.ActivityPub.Publisher</code> and for incoming federation in <code class="inline">Bonfire.ActivityPub.Adapter</code>.</p><h2 id="naming" class="section-heading">
  <a href="#naming" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Naming
</h2>
<p>It is said that naming is one of the four hard problems of computer
science (along with cache management and off-by-one errors). We don't
claim our scheme is the best, but we do strive for consistency.</p><p>Naming rules:</p><ul><li>Context names all begin <code class="inline">Bonfire.</code> and are named in plural where possible.</li><li>Everything within a context begins with the context name and a <code class="inline">.</code></li><li>Ecto schemas should be named in the singular</li><li>Database tables should be named in the singular</li><li>Acronyms in module names should be all uppercase</li><li>OTP services should have the <code class="inline">Service</code> suffix (without a preceding <code class="inline">.</code>)</li></ul>
<div class="bottom-actions">
  <div class="bottom-actions-item">

      <a href="deploy.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
Backend Configuration and Deployment
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="graphql.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
Bonfire GraphQL Guide
        </span>
      </a>

  </div>
</div>

      <footer class="footer">

        <p>
          <span class="line">
            Built using
            <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener">ExDoc</a> (v0.25.5) for the
            <a href="https://elixir-lang.org" title="Elixir" target="_blank">Elixir programming language</a>.
          </span>
          <span class="line">
            Designed by
            <a href="https://twitter.com/dignifiedquire" target="_blank" rel="noopener" title="@dignifiedquire">Friedel Ziegelmayer</a>.
          </span>
        </p>
        <p>

            <a href="api-reference.html" title="API reference" class="line footer-button">API Reference</a>

          <button class="line footer-button display-shortcuts-help">
            Display keyboard shortcuts
          </button>
          <button class="line footer-button night-mode-toggle">
            Toggle night mode
          </button>
          <button class="line footer-button display-quick-switch">
            Go to a HexDocs package
          </button>
          <button class="line footer-button tooltips-toggle">
            <span class="tooltips-option-disable">Disable tooltips</span>
            <span class="tooltips-option-enable">Enable tooltips</span>
          </button>
        </p>
      </footer>
    </div>
  </div>
</section>
</div>


  </body>
</html>
